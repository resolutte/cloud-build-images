steps:

# Login to provide credentials for the push.
- name: "gcr.io/cloud-builders/docker"
  entrypoint: "bash"
  args: ["-c", "docker login --username=resolutte --password=$$PASSWORD"]
  secretEnv: ["PASSWORD"]

# Build the image.
- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '--build-arg'
  - 'version=$SHORT_SHA'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-5.6:latest'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-5.6:$SHORT_SHA'
  - '-f'
  - 'php-fpm-5.6/Dockerfile'
  - '.'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '--build-arg'
  - 'version=$SHORT_SHA'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.2:latest'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.2:$SHORT_SHA'
  - '-f'
  - 'php-fpm-7.2/Dockerfile'
  - '.'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '--build-arg'
  - 'version=$SHORT_SHA'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.3:latest'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.3:$SHORT_SHA'
  - '-f'
  - 'php-fpm-7.3/Dockerfile'
  - '.'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '--build-arg'
  - 'version=$SHORT_SHA'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.4:latest'
  - '-t'
  - 'gcr.io/$PROJECT_ID/php-fpm-7.4:$SHORT_SHA'
  - '-f'
  - 'php-fpm-7.4/Dockerfile'
  - '.'

# Push the image to Dockerhub.
- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'push'
  - 'resolutte/php-fpm-5.6:latest'
  - 'resolutte/php-fpm-5.6:$SHORT_SHA'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'push'
  - 'resolutte/php-fpm-7.2:latest'
  - 'resolutte/php-fpm-7.2:$SHORT_SHA'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'push'
  - 'resolutte/php-fpm-7.3:latest'
  - 'resolutte/php-fpm-7.3:$SHORT_SHA'

- name: 'gcr.io/cloud-builders/docker'
  args:
  - 'push'
  - 'resolutte/php-fpm-7.4:latest'
  - 'resolutte/php-fpm-7.4:$SHORT_SHA'

# Dockerhub Password
secrets:
  - kmsKeyName: "projects/resolutte-264622/locations/global/keyRings/Resolutte/cryptoKeys/docker-hub"
    secretEnv:
      PASSWORD: "CiQAdXh3aKdd1NsLONJFjz9fv3exCLmbm03k984tS2xCS0gSqHESPQDhENgDjOVi42SXgNBjReCs8f0TMHF+fTwJsGrub/FqZAQCyzViraoNilJcEHdRLRvsBX3hYeTqaScTW6k="